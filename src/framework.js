(()=>{function k(){return"React"in window&&"createElement"in React&&"Fragment"in React?(window.h=React.createElement,window.f=React.Fragment,!0):"h"in window&&"f"in window}var N=setInterval(()=>{k()&&clearInterval(N)},100);var _="http://localhost:3248/api";var o=(c,e)=>e?(e.headers=e.headers||{},e.headers.BETTERNCM_API_KEY=BETTERNCM_API_KEY,fetch(_+c,e)):fetch(_+c,{headers:{BETTERNCM_API_PATH:_}});var p=encodeURIComponent,P;(n=>{async function c(t){return await(await o(`/fs/read_dir?path=${p(t)}`)).json()}n.readDir=c;async function e(t){return await(await o(`/fs/read_dir?path=${p(t)}`)).text()}n.readFileText=e;async function s(t,r=`${t}_extracted/`){return(await o(`/fs/unzip_file?path=${p(t)}&dest=${p(r)}`)).status===200}n.unzip=s;async function a(t,r){return(await o(`/fs/write_file_text?path=${p(t)}`,{method:"POST",body:r})).status===200}n.writeFileText=a;async function u(t,r){return new FormData().append("file",r),(await o(`/fs/write_file?path=${p(t)}`,{method:"POST",body:r})).status===200}n.writeFile=u;async function g(t){return(await o(`/fs/mkdir?path=${p(t)}`)).status===200}n.mkdir=g;async function x(t){return await(await o(`/fs/exists?path=${p(t)}`)).json()}n.exists=x;async function i(t){return(await o(`/fs/remove?path=${p(t)}`)).status===200}n.remove=i})(P||={});var S;(E=>{async function c(l,m=!1,T=!1){return(await o(`/app/exec${m?"_ele":""}${T?"?_showWindow":""}`,{method:"POST",body:l})).status===200}E.exec=c;var e=null;async function s(){return e===null&&(e=await(await o("/app/version")).text()),e}E.getBetterNCMVersion=s;async function a(){return await(await o("/app/bg_screenshot")).text()}E.takeBackgroundScreenshot=a;async function u(){return await(await o("/app/get_win_position")).json()}E.getNCMWinPos=u;async function g(){return(await o("/app/reload_plugin")).status===200}E.reloadPlugins=g;async function x(){return(await(await o("/app/datapath")).text()).replace(/\//g,"\\")}E.getDataPath=x;async function i(l,m){return await(await o(`/app/read_config?key=${p(l)}&default=${p(m)}`)).text()}E.readConfig=i;async function n(l,m){return await(await o(`/app/write_config?key=${p(l)}&value=${p(m)}`)).text()}E.writeConfig=n;async function t(){return await(await o("/app/ncmpath")).text()}E.getNCMPath=t;async function r(){return(await o("/app/show_console")).status===200}E.showConsole=r;async function f(l=!0){return(await o(`/app/set_rounded_corner?enable=${l}`)).status===200}E.setRoundedCorner=f;async function d(l,m){return await(await o(`/app/open_file_dialog?filter=${p(l)}&initialDir=${p(m)}`)).text()}E.openFileDialog=d;async function y(){return await(await o("/app/is_light_theme")).text()==="true"}E.isLightTheme=y;async function v(){return await(await o("/app/get_succeeded_hijacks")).json()}E.getSucceededHijacks=v})(S||={});var b;(x=>{function c(i,n){for(var t in i){for(var r=!0,f=0,d=n;f<d.length;f++){var y=d[f];i[t].toString().includes(y)||(r=!1)}if(r)return t}}x.findNativeFunction=c;function e(i,n=window,t=["window"],r=[],f=[]){if(n==null)return[];if(r.push(n),typeof n[i]=="function"&&f.push([n[i],[...t]]),t.length<10)for(let d of Object.keys(n))Object.hasOwnProperty.call(n,d)&&typeof n[d]=="object"&&!r.includes(n[d])&&(t.push(d),e(i,n[d],t,r,f),t.pop());return r.pop(),f}x.searchApiFunction=e;function s(i,n=window,t=["window"]){let r=e(i,n,t);return r.length>0?r[0]:null}x.findApiFunction=s;let a=null;function u(){return a===null?(a=s("getPlaying")?.[0]||null,null):a===null?null:a()}x.getPlayingSong=u;function g(){let i=u(),n={id:i.data.id,title:i.data.name,type:"normal"};return i.from.fm&&(n.type="fm"),n}x.getPlaying=g})(b||={});var $;(a=>{function c(u,g=100){return e(()=>document.querySelector(u),g)}a.waitForElement=c;function e(u,g=100){return new Promise(x=>{let i=setInterval(()=>{let n=u();n&&(clearInterval(i),x(n))},g)})}a.waitForFunction=e;function s(u){return new Promise(g=>setTimeout(g,u))}a.delay=s})($||={});var j;(s=>{async function c(a){console.warn("Test Failed",a),await P.writeFileText("/__TEST_FAILED__.txt",a)}s.fail=c;async function e(a){console.warn("Test Succeeded",a),await P.writeFileText("/__TEST_SUCCEEDED__.txt",a)}s.success=e})(j||={});var M={fs:P,app:S,ncm:b,utils:$,tests:j,reload(){let c=loadingMask.animate([{opacity:0},{opacity:1}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42, 0, 0.58, 1)"});c.commitStyles(),c.addEventListener("finish",e=>{document.location.reload()})}};location.reload=M.reload.bind(void 0);betterncm=M;var w=M;var F=class extends EventTarget{constructor(e,s){super(),this.manifest=e,this.pluginPath=s,this.addEventListener("load",a=>{this.injects.forEach(u=>{u.dispatchEvent(a)})}),this.addEventListener("allpluginsloaded",a=>{this.injects.forEach(u=>{u.dispatchEvent(a)})})}pluginPath="";injects;manifest;finished},C=class extends EventTarget{pluginPath="";manifest;configViewElement=null;mainPlugin;constructor(e){super(),this.mainPlugin=e,this.manifest=e.manifest,this.pluginPath=e.pluginPath}onLoad(e){this.addEventListener("load",s=>{e(s.detail,s)})}onConfig(e){this.addEventListener("config",s=>{this.configViewElement=e(s.detail)})}onAllPluginsLoaded(e){this.addEventListener("allpluginsloaded",s=>{e(s.detail,s)})}getConfig(e,s){let a=JSON.parse(localStorage[`config.betterncm.${this.manifest.name}`]||"{}");return a[e]!==void 0?a[e]:s}setConfig(e,s){let a=JSON.parse(localStorage[`config.betterncm.${this.manifest.name}`]||"{}");a[e]=s,localStorage[`config.betterncm.${this.manifest.name}`]=JSON.stringify(a)}},h={};async function L(){let c=async function(){}.constructor,s={"/pub/app.html":"Main"}[location.pathname];async function a(i,n=!1){let t=JSON.parse(await w.fs.readFileText(`${i}/manifest.json`)),r=new F(t,i);h[t.name]=r;async function f(d){let y=w.fs.readFileText.bind(null,d),v=await y();if(n&&setInterval(async()=>{v!==await y()&&w.reload()},500),d.endsWith(".js")){let E=new C(r);new c("plugin",v).call(h[t.name],E),E.dispatchEvent(new CustomEvent("load",{detail:E})),h[t.name].injects.push(E)}}if(t.injects[s])for(let d of t.injects[s])await f(`${i}/${d.file}`);if(t.injects[location.pathname])for(let d of t.injects[location.pathname])await f(`${i}/${d.file}`)}let u=[],g=[];window.loadedPlugins=h,window.loadFailedErrors=g;let x=await w.fs.readDir("./plugins_runtime");for(let i of x)u.push(a(i).then(()=>{}).catch(n=>{throw Error(`Failed to load plugin ${i}: ${n.toString()}`)}));if(await w.fs.exists("./plugins_dev")){let i=await w.fs.readDir("./plugins_dev");for(let n of i)u.push(a(n,!0).then(()=>{}).catch(t=>{console.error(`Failed to load dev plugin ${n}: ${t.toString()}`),g.push([n,t])}))}await Promise.all(u);for(let i in h)h[i].injects.forEach(n=>n.dispatchEvent(new CustomEvent("allpluginsloaded",{detail:h})))}window.addEventListener("DOMContentLoaded",async()=>{if(w.reload=()=>{let c=loadingMask.animate([{opacity:0},{opacity:1}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42,0,0.58,1)"});c.commitStyles(),c.addEventListener("finish",e=>{document.location.reload()})},await Promise.all([L(),w.utils.waitForElement("nav",400)]),loadingMask.animate([{opacity:1},{opacity:0,display:"none"}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42,0,0.58,1)"}).commitStyles(),!("PluginMarket"in h)){let c=parseInt(localStorage["cc.microblock.loader.reloadPluginAttempts"]||"0");c<3?(localStorage["cc.microblock.loader.reloadPluginAttempts"]=c+1,document.location.reload()):(localStorage["cc.microblock.loader.reloadPluginAttempts"]="0",alert(`\u63D2\u4EF6\u7BA1\u7406\u5668\u52A0\u8F7D\u5931\u8D25\uFF01\u5DF2\u91CD\u8BD5 ${c} \u6B21\u4ECD\u7136\u52A0\u8F7D\u5931\u8D25\u3002
\u8BF7\u68C0\u67E5\u662F\u5426\u6709\u4E0D\u517C\u5BB9\u63D2\u4EF6\u6216\u51B2\u7A81\u7684\u63D2\u4EF6\uFF01`))}});})();
//# sourceMappingURL=framework.js.map
